module Tests.Distribution.Syndication.Trading where

import Daml.Script
import DA.Finance.Types (Asset(..))
import DA.Set (singleton)
import Marketplace.Settlement.Hierarchical.Dvp qualified as Hierarchical (Dvp)
import Marketplace.Settlement.Hierarchical.Util (SettlementMode(..))
import Marketplace.Trading.Model (Side(..))
import Marketplace.Trading.Otc.Model qualified as Trading
import Marketplace.Trading.Otc.Service qualified as Trading
import Tests.Distribution.Syndication.Setup (setup, Parties(..))
import Tests.Distribution.Syndication.Issuance (issuance)
import Tests.Distribution.Syndication.Origination (origination, Origination(..))
import Tests.Distribution.Syndication.Util

setTradingStatus : Party -> Bool -> Script [ContractId Trading.Service]
setTradingStatus operator isTradingAllowed = do
  serviceCids <- map fst <$> queryFilter @Trading.Service operator (\s -> s.operator == operator)
  submit operator do mapA (\sCid -> exerciseCmd sCid Trading.SetStatus with isTradingAllowed) serviceCids

createOrder : Party -> Party -> Party -> Party -> Party -> Text -> Asset -> Asset -> Side -> SettlementMode -> Script (ContractId Trading.Order)
createOrder operator customer counterparty deliveryRegistrar paymentRegistrar id delivery payment side settlementMode = do
  submit customer do exerciseByKeyCmd @Trading.Service (operator, operator, customer) Trading.CreateOrder with ..

acceptOrder : Party -> Party -> ContractId Trading.Order -> Script (ContractId Trading.Match)
acceptOrder operator customer orderCid = do
  submit customer do exerciseByKeyCmd @Trading.Service (operator, operator, customer) Trading.AcceptOrder with ctrl = customer; orderCid

instructMatch : Party -> ContractId Trading.Match -> Script (ContractId Hierarchical.Dvp)
instructMatch operator matchCid = do
  submit operator do exerciseCmd matchCid Trading.Instruct

test : Script ()
test = do
  parties@Parties{..} <- setup
  orig <- origination parties
  issuance parties orig
  trading parties orig

trading : Parties -> Origination -> Script ()
trading Parties{..} Origination{..}= do

  deposit operator cashProvider  lm1        1_000_000.0 usd.assetId
  deposit operator lm1           investor1  1_000_000.0 (usd.assetId with signatories = singleton lm1)

  setTradingStatus operator True
  let
    delivery = Asset with id = bond1Desc.assetId; quantity = 1_000_000.0
    payment = Asset with id = usd.assetId; quantity = 1_000_000.0
  orderCid <- createOrder operator investor1 investor2 bondRegistrar cashProvider "TRD1" delivery payment Buy Dvp
  matchCid <- acceptOrder operator investor2 orderCid
  tradeCid <- instructMatch operator matchCid

  allocateInstructions [ lm1, lm2, investor1, investor2, custodian1, custodian2 ]
  signInstructions [ lm1, lm2, investor1, investor2, custodian1, custodian2 ]
  settleTrade operator tradeCid

  consolidate [ lm1, lm2, investor1, investor2, custodian1, custodian2 ]

  pure ()
